<?php
if (!defined('ABSPATH')) { exit; }
class RSP_Module_Malware_Scanner implements RSP_Module_Interface {
    public function init(){}
    public function scan_quick($root=''){
        if(!$root){ $root=WP_CONTENT_DIR; }
        $bad=[]; $max=8000;
        $it=new RecursiveIteratorIterator(new RecursiveDirectoryIterator($root, FilesystemIterator::SKIP_DOTS));
        $patterns=['/base64_decode\s*\(/i','/eval\s*\(/i','/shell_exec\s*\(/i','/passthru\s*\(/i','/system\s*\(/i','/assert\s*\(/i','/gzinflate\s*\(/i'];
        foreach($it as $path=>$info){
            if($max--<=0) break;
            if($info->isFile() && strtolower($info->getExtension())==='php'){
                $txt=@file_get_contents($path); if($txt===false) continue;
                foreach($patterns as $re){ if(preg_match($re,$txt)){ $bad[]=['file'=>$path,'match'=>$re]; break; } }
            }
        }
        return ['root'=>$root,'matches'=>$bad,'scanned'=>8000-$max];
    }
}
